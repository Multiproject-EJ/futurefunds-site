<!doctype html>
<html lang="en" data-lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FutureFunds â€” Universe</title>

<!-- Site styles -->
<link rel="stylesheet" href="/assets/styles.css"/>

<style>
  /* Page-local styles (keeps your global tokens) */
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  .hero h1{margin:.2rem 0 .5rem}
  .hero p{margin:0;color:var(--muted,#64748b)}

  .controls{display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 18px}
  .controls input,.controls select{padding:10px 12px;border:1px solid var(--border,#e5e7eb);border-radius:12px;background:var(--panel,#fff)}
  .controls .btn{padding:10px 12px;border:1px solid var(--border,#e5e7eb);border-radius:12px;background:var(--panel,#fff);cursor:pointer}
  .controls .btn:hover{border-color:var(--accent,#1a73e8)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0 16px}
  .chip{font-size:12px;padding:6px 10px;border:1px solid var(--border,#e5e7eb);border-radius:999px;background:var(--panel,#fff);cursor:pointer}
  .chip.active{border-color:var(--accent,#1a73e8)}

  .table-wrap{background:var(--panel,#fff);border:1px solid var(--border,#e5e7eb);border-radius:16px;box-shadow:var(--shadow,0 12px 34px rgba(0,0,0,.06));overflow:hidden}
  table.grid{width:100%;border-collapse:collapse}
  .grid th,.grid td{padding:12px 14px;border-bottom:1px solid var(--border,#e5e7eb);vertical-align:top}
  .grid thead th{position:sticky;top:62px;background:var(--bg,#f6f7fb);z-index:5;text-align:left}
  .grid tbody tr{cursor:pointer}
  .grid tbody tr:hover{background:#f8fafc}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:12px;padding:3px 8px;border:1px solid var(--border,#e5e7eb);border-radius:999px}

  .empty{padding:32px;text-align:center;color:var(--muted,#64748b)}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px}
  .modal{max-width:900px;width:100%;background:var(--panel,#fff);border-radius:18px;box-shadow:var(--shadow,0 12px 34px rgba(0,0,0,.18));border:1px solid var(--border,#e5e7eb)}
  .modal header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid var(--border,#e5e7eb)}
  .modal .body{padding:16px 18px;max-height:70vh;overflow:auto}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:1px 6px;font-size:12px}

  /* Small screens */
  @media (max-width: 740px){
    .grid th:nth-child(4), .grid td:nth-child(4){display:none} /* hide Visual/Table on mobile */
    .grid th:nth-child(5), .grid td:nth-child(5){display:none} /* hide Conclusion on mobile */
  }
</style>
</head>
<body>

<!-- Top bar -->
<header class="site-header">
  <a class="brand" href="/">
    <img src="/images/logo.webp" alt="FutureFunds.ai logo" class="logo" />
    <span>FutureFunds.ai</span>
  </a>
  <nav class="nav">
    <a href="/strategy.html" data-i18n="nav.strategy">Strategy</a>
    <a href="/tools.html" data-i18n="nav.investmentTools">Investment Tools</a>
    <a href="/ai-economy.html" data-i18n="nav.aiEconomy">The AI Economy</a>
    <a href="/portfolio.html" data-i18n="nav.portfolios">Portfolios</a>
    <a href="/universe.html" class="active" data-i18n="nav.universe">Universe</a>
    <button id="langBtn" class="btn small">EN â–¾</button>
    <button id="themeToggle" class="btn small ghost" aria-label="Toggle theme">ðŸŒ—</button>
    <a id="patreonLogin" class="btn danger" href="/membership.html" data-i18n="cta.membership">Membership</a>
  </nav>
</header>

<!-- Hero -->
<section class="wrap hero" style="margin-top:18px">
  <h1>Universe â€” Daily Deep Dives</h1>
  <p>Auto-generated research via OpenRouter. Filter, explore, export. Tip: press <span class="kbd">/</span> to search.</p>
</section>

<!-- Controls -->
<main class="wrap">
  <div class="controls">
    <input id="q" placeholder="Search topic, findings, conclusionâ€¦" aria-label="Search"/>
    <select id="tagSel" aria-label="Filter by tag">
      <option value="">All tags</option>
    </select>
    <input id="from" type="date" aria-label="From date"/>
    <input id="to" type="date" aria-label="To date"/>
    <button id="btnExportCsv" class="btn" title="Export current view to CSV">Export CSV</button>
    <button id="btnCopyJson" class="btn" title="Copy current view as JSON">Copy JSON</button>
    <button id="btnRefresh" class="btn" title="Reload data">Refresh</button>
  </div>

  <!-- Tag chips (top 12) -->
  <div id="chips" class="chips"></div>

  <div class="table-wrap">
    <table class="grid" id="grid">
      <thead>
        <tr>
          <th style="width:110px">Date</th>
          <th style="width:300px">Topic</th>
          <th>Key Findings</th>
          <th style="width:320px">Visual/Table</th>
          <th style="width:280px">Conclusion</th>
          <th style="width:160px">Tags</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td class="empty" colspan="6">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- Modal -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <header>
      <strong id="mTitle">Details</strong>
      <button id="mClose" class="btn" style="border:none;background:transparent;font-size:22px;cursor:pointer" aria-label="Close">Ã—</button>
    </header>
    <div class="body" id="mBody">
      <!-- filled dynamically -->
    </div>
  </div>
</div>

<script src="/assets/app.js" defer></script>
<script src="/assets/i18n.js" defer></script>
<script src="/assets/paywall.js" defer></script>

<script>
(async function UniversePage(){
  const state = {
    rows: [],
    filtered: [],
    q: localStorage.getItem("universe_q") || "",
    tag: localStorage.getItem("universe_tag") || "",
    from: localStorage.getItem("universe_from") || "",
    to: localStorage.getItem("universe_to") || ""
  };

  const $ = sel => document.querySelector(sel);
  const tbody = $("#tbody");
  const q = $("#q"), tagSel = $("#tagSel"), from = $("#from"), to = $("#to");
  const chips = $("#chips");
  const modal = $("#modal"), mTitle = $("#mTitle"), mBody = $("#mBody"), mClose = $("#mClose");

  // Keyboard: '/' focuses search
  window.addEventListener("keydown", (e)=>{
    if (e.key === "/" && document.activeElement !== q){
      e.preventDefault(); q.focus();
    }
    if (e.key === "Escape" && modal.style.display === "flex") closeModal();
  });

  // Fetch data
  async function load(){
    const res = await fetch("/data/universe.json?ts="+Date.now(), {cache:"no-store"});
    const rows = await res.json();
    // Sort newest first
    state.rows = rows.sort((a,b)=> (a.date < b.date ? 1 : -1));
  }

  // Build tag options + chips
  function buildTags(){
    const counts = new Map();
    state.rows.forEach(r => (r.tags||[]).forEach(t => counts.set(t, (counts.get(t)||0)+1)));
    // Select
    tagSel.innerHTML = '<option value="">All tags</option>' +
      [...counts.keys()].sort().map(t=>`<option value="${t}">${t}</option>`).join("");
    tagSel.value = state.tag;

    // Chips: top 12 by count
    const top = [...counts.entries()].sort((a,b)=> b[1]-a[1]).slice(0,12);
    chips.innerHTML = top.map(([t,c])=>`<button class="chip ${state.tag===t?"active":""}" data-tag="${t}">${t} Â· ${c}</button>`).join("");
    chips.querySelectorAll(".chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.dataset.tag;
        state.tag = (state.tag===v ? "" : v);
        localStorage.setItem("universe_tag", state.tag);
        render();
        buildTags(); // refresh active state
      });
    });
  }

  // Render table
  function render(){
    // Persist filters
    localStorage.setItem("universe_q", q.value = state.q);
    localStorage.setItem("universe_from", from.value = state.from);
    localStorage.setItem("universe_to", to.value = state.to);

    const inRange = (d) => {
      if (!d) return false;
      if (state.from && d < state.from) return false;
      if (state.to && d > state.to) return false;
      return true;
    };

    const qNeedle = state.q.trim().toLowerCase();
    const withinQuery = (r) => {
      if (!qNeedle) return true;
      return JSON.stringify(r).toLowerCase().includes(qNeedle);
    };

    state.filtered = state.rows
      .filter(r => !state.tag || (r.tags||[]).includes(state.tag))
      .filter(r => (!state.from && !state.to) || inRange(r.date))
      .filter(withinQuery);

    if (!state.filtered.length){
      tbody.innerHTML = `<tr><td class="empty" colspan="6">No results. Try clearing filters.</td></tr>`;
      return;
    }

    // Build rows
    const html = state.filtered.map(r=>{
      const findings = (r.key_findings||[]).slice(0,6).map(x=>`â€¢ ${escapeHtml(x)}`).join("<br>");
      const tags = (r.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");
      return `
        <tr data-id="${escapeHtml(r.date+"|"+(r.topic||""))}">
          <td>${escapeHtml(r.date||"")}</td>
          <td>${escapeHtml(r.topic||"")}</td>
          <td>${findings}</td>
          <td><pre style="white-space:pre-wrap;margin:0">${escapeHtml(r.visual_table_md||"")}</pre></td>
          <td>${escapeHtml(r.conclusion||"")}</td>
          <td class="tags">${tags}</td>
        </tr>`;
    }).join("");
    tbody.innerHTML = html;

    // Row click â†’ modal
    tbody.querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const id = tr.getAttribute("data-id");
        const row = state.filtered.find(r => (r.date+"|"+(r.topic||"")) === id);
        if (!row) return;
        openModal(row);
      });
    });
  }

  // Modal
  function openModal(r){
    mTitle.textContent = r.topic || "Details";
    mBody.innerHTML = `
      <div style="display:grid;gap:12px">
        <div><strong>Date:</strong> ${escapeHtml(r.date||"")}</div>
        <div><strong>Conclusion:</strong><br>${escapeHtml(r.conclusion||"")}</div>
        <div><strong>Key Findings:</strong><br>${(r.key_findings||[]).map(x=>`â€¢ ${escapeHtml(x)}`).join("<br>")}</div>
        <div><strong>Visual/Table (markdown):</strong>
          <pre style="white-space:pre-wrap">${escapeHtml(r.visual_table_md||"")}</pre>
          <button id="copyMd" class="btn" style="margin-top:6px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--panel)">Copy markdown</button>
        </div>
        <details>
          <summary class="kbd">Prompt used (debug)</summary>
          <pre style="white-space:pre-wrap">${escapeHtml(r.prompt_used||"")}</pre>
        </details>
      </div>`;
    modal.style.display = "flex";
    $("#copyMd").addEventListener("click", async ()=>{
      await navigator.clipboard.writeText(r.visual_table_md||"");
      toast("Markdown copied");
    });
  }
  function closeModal(){ modal.style.display = "none"; }
  mClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

  // Filters events
  q.addEventListener("input", ()=>{ state.q = q.value; render(); });
  tagSel.addEventListener("change", ()=>{ state.tag = tagSel.value; localStorage.setItem("universe_tag", state.tag); render(); });
  from.addEventListener("change", ()=>{ state.from = from.value; render(); });
  to.addEventListener("change", ()=>{ state.to = to.value; render(); });
  $("#btnRefresh").addEventListener("click", async ()=>{ await load(); buildTags(); render(); toast("Data refreshed"); });
  $("#btnExportCsv").addEventListener("click", ()=> exportCsv(state.filtered));
  $("#btnCopyJson").addEventListener("click", async ()=>{
    await navigator.clipboard.writeText(JSON.stringify(state.filtered, null, 2));
    toast("JSON copied");
  });

  // Tiny toast
  function toast(msg){
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.cssText = "position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)";
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 1400);
  }

  // CSV export
  function exportCsv(rows){
    if (!rows?.length) return toast("Nothing to export");
    const header = ["date","topic","key_findings","visual_table_md","conclusion","tags"];
    const csv = [
      header.join(","),
      ...rows.map(r=>{
        const vals = [
          r.date||"",
          r.topic||"",
          (r.key_findings||[]).join(" | "),
          (r.visual_table_md||"").replace(/\n/g,"\\n"),
          r.conclusion||"",
          (r.tags||[]).join("|")
        ].map(csvEscape);
        return vals.join(",");
      })
    ].join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `universe_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function csvEscape(v){
    const s = String(v);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // Initialize filters from storage
  q.value = state.q; tagSel.value = state.tag; from.value = state.from; to.value = state.to;

  // Load + render
  await load();
  buildTags();
  render();
})();
</script>
</body>
</html>
